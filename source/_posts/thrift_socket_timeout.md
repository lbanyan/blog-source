---
title: Thrift客户端统计的服务超时次数大于服务端统计的超时次数
tags:
  - Thrift
  - socketTimeout
---

## 现象
虎牙主播推荐功能中，用于获取推荐列表的客户端出现大量的请求服务端超时现象，但服务端日志无ERROR的异常。

## 原因
经排查，一是网络正常，二是客户端只是请求了服务端，并没有做其他耗时操作，三是客户端发送请求的数量大于服务端处理请求的数量（此处客户端有客户端发送请求的数量统计，服务端在每次处理完请求后会异步记录入数据库）。那么问题应该出在客户端和服务端的连接这里。
最终找到了原因：Thrift的“Connection reset by peer”异常等级为WARN级，由于平台的QPS很高，在服务端我们的Log使用的是ERROR级，因而并未打印出这类WARN异常。
![](/img/thrift_socket_timeout.png)
