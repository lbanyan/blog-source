---
title: 电商平台发送微信模板消息优化方案
date: 2018-08-21 20:15
---

### 背景
公司是一家电商平台，负责数千家 [小电铺](https://xiaodianpu.com/) 、数百个小程序的运营，用户规模千万级。公司在举办像 618 这样的活动大促时，需要向用户发送模板消息，以起到活动推广作用。
之前系统中的发送模板消息功能基本只能做到每秒钟发送一条消息，性能极低，给一个小电铺下的所有用户发送消息，有时候需要半天的时间。对于整个平台，数千家的小电铺，是完全无法满足性能要求的。

<!--more-->

### 旧方案的分析
旧系统发送模板消息流程：
![](/img/perf_template_message/old_template_message.jpg)
这也是通常做此类需求的思路，这里创建小电铺消息模板、获取微信access_token、向每个用户发送消息都使用同步HTTP请求与微信交互。

### 优化方案
优化后的系统发送模板消息流程：
![](/img/perf_template_message/perf_template_message.jpg)
借助MQ，实现多任务多机并行处理。
在小电铺层面先进行一层任务切分，实现多机多线程并行构造各小电铺模板消息的目的，构造完成的模板消息，也不直接发送，而是再次放入MQ中，再次进行多机并行请求微信发送模板消息，请求微信接口时用异步 HTTP 来实现。

### 优化结果
优化后，每秒钟约发送一万条模板消息，相对于之前每秒钟一条，提升性能约一万倍。
不幸的是，因为发送过快，同时收到消息的用户很多，他们根据模板消息的指引，同时进入了小电铺的主页，直接打垮了我们的系统后端。