---
title: 后台配置元素排序的几种实现
date: 2018-01-28 18:09
tag:
    - 排序
---

### 背景

做后台管理功能时，常遇到此场景：各配置条目的顺序应该是管理员可定制的。例如 AWS 用户创建 EC2 实例选择服务器配置时，1核CPU/500MB内存配置条目应在2核/4GB内存配置之前，新加入的1核CPU/1GB内存配置应位于上述两种配置之间。那 AWS 后台是如何做到这样的排序管理的呢？

<!--more-->

### 基本思路

该配置表中增加 sort_no 字段，用以表明各配置的序号，查询接口根据该字段排序以显示给前端。

### 方案一

管理员需手动改写各条目的序号 sort_no 的值，以维护显示顺序。
该方案适用于配置较少，且为公司内部管理员的场景，对于配置较多，且面向普通大众来说，会很麻烦。

### 方案二

后台前端增加 置顶/向上移一位/向下移一位/置底 按钮，通过调用后端移位接口实现，新增元素默认置顶，sort_no 值越小越靠前。以下是各操作的实现思路：

- 置顶：配置中最小的 sort_no 减 1 作为需置顶元素的 sort_no；
- 向上移一位：和该配置的上一个配置的 sort_no 交换；
- 向下移一位：和该配置的下一个配置的 sort_no 交换；
- 置底：配置中最大的 sort_no 加 1 作为需置底元素的 sort_no。

### 方案三

移位操作无非就是将一个元素置于另外两个元素之间，特殊情况，如置顶和置底操作，我们可以假设最顶部有个虚拟的配置，该配置的 sort_no = 0，最底部有个虚拟的配置，该配置的 sort_no = Integer.MAX。这样，所有的移位操作便统一为将一个元素置于另外两个元素之间。在 sort_no 可为小数的前提下，移位元素的 sort_no 设置为其移位后上下两元素的 sort_no 之和的平均值，来实现移位。

此方式会有两个问题：

- 受 double 类型精度限制，当出现 sort_no 小数点后达到 15 位时，需将所有 sort_no 重新排序；
- 2.5 + 1.5 / 2，期望得到 2，有可能会得到 1.99999944... 的情况，导致每一次求平均数时，都达到上述第一条限制，从而全量重排，此时需借助 BigDecimal 来求平均值。

此做法的优点是不需要额外的排序接口，元素的插入和移位操作均可以在元素的新增和修改接口中完成。缺点也很明显，逻辑复杂，不具备实现的简洁性。

注意：如果使用 SQL 的 ORDER BY，sort_no 不应为字符串，例如 1、2、12 为字符串时，AES 排序结果就变为了 1、12、2。
