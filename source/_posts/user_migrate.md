---
title: 统一用户系统用户迁移方案
date: 2019-3-14 11:15
---

### 现状
![](/img/user_migrate/now.png)

### 方案
以瓜花为例，小电铺2.0、小电铺3.0迁移雷同。
![](/img/user_migrate/migrate.png)

1、	提供旧用户数据迁移到新用户系统的服务（包括基本数据迁移、绑定手机号迁移、授权关系迁移功能）
2、	新用户系统中提供双写服务功能
3、	瓜花Mapi新增和修改用户信息需发送MQ消息
4、	使用步骤1中的服务将旧瓜花用户数据迁移到新用户系统
5、	步骤2和步骤3上线，支持瓜花用户双写，将步骤4和步骤5期间的新增用户使用步骤4方法再次迁移
6、	瓜花Mapi支持用户灰度，灰度用户走新用户系统，瓜花、小电铺2.0、小电铺3.0系统、新用户系统user_id统一使用redis生成
7、	新用户系统上线后，步骤6上线
8、	瓜花通过灰度用户，放量到新的用户系统

瓜花完全放量到新用户系统后，小电铺2.0、小电铺3.0也按照步骤3~8完成用户灰度到新用户系统。
瓜花、小电铺2.0、小电铺3.0接入新用户系统用户查询功能，完成所有接口的迁移。
所有项目迁移完成后，停用双写服务。

### 灰度用户
由APP、小程序、H5提供设备唯一标识，使用该标识对用户进行灰度。

### 应急方案
采用双写模式后，新旧系统相互兼容，瓜花可在任意时刻切回旧用户系统或减少灰度用户量，防止新用户系统异常或负载过高导致瓜花用户无法正常登录的问题。

### 风险点
一、双写延时，用户灰度变动，导致出现重复用户的情况。
这种情况需要同时满足以下条件：
1、	灰度调整的那一刻
2、	那一段时间内的新用户
3、	正好那些新用户通过旧系统登录成功了，被重新灰度到新系统上（这是不存在的，因为用户此阶段只存在一次请求登录接口的行为，不存在说会被再灰度登录）
4、	正好那些新用户通过旧系统登录失败了，被重新灰度到新系统上
对于条件4，用户若确实登录失败，不会记录入库，不存在重复写用户行为；用户如果登录成功，但返回给前端的路途中失败了，基本是因为超时（通常网络不好），这种情况下大概率数据库双写已完成，为了稳妥起见，双写服务提供openid相同但userid不同 时的异常日志跟踪功能。

二、用户数据迁移过程中，部分用户信息修改，改动的数据未迁移
存在以下两种情况：
1、	手机号绑定
因为这种修改没有更新时间字段的标识，在用户数据迁移完成，双写服务上线后，二次刷新所有用户手机号信息即可。
2、	用户后期授权
这是一种新增记录的行为，使用之前步骤4和步骤5即可解决。
三、步骤5会出现修改用户数据，而新系统没有该用户，导致修改失败的情况
因为这一步中又执行了一次步骤4的动作，保证这一部分用户在新系统中已存在，修改失败的记录会进行重试，确保一定会修改成功。
