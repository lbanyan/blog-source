---
title: 偶尔出现Redis客户端获取不到Redis数据的情况
date: 2017-06-29 21:21
tags:
    - Redis
---

### 现象
在美国东部弗吉尼亚州部署有我们数个agent服务，该agent使用Java实现，通过blpop获取我们东莞机房中放入Redis服务端的指令。agent和Redis之间的链路较长，此链路通过深圳机房代理转发到香港机房，再从香港机房代理转发到弗吉尼亚机房，至于为什么要这样，是因为大家都懂的不可描述的原因。偶尔发现agent无法接收到相关指令，导致我们服务超时异常的情况。但在弗吉尼亚，通过简单的Redis客户端命令却可以正常获取到Redis中的指令。

<!--more-->

### 分析
不存在中间链路层断开的情况，因为经测试，中间链路层断开，Redis客户端会直接抛错。很有可能是我们的这条链路太长，数据在中间传输过程中，会出现丢失的情况。而我们在弗吉尼亚通过Redis客户端直连Redis，可以正常获取到Redis中的指令，似乎也印证了我们的推论。
由于本系统发送指令并不频繁且指令内容较小，因而我们取消了中间的各种代理转发，采用弗吉尼亚州的agent直连东莞Redis的方式，经验证，未再出现上述现象。

> 2018年2月10日更新，上述分析有可能是错误的，详见 [Redis 半开连接问题](http://blog.lbanyan.com/redis_half_open_connections/#more) 一文。
